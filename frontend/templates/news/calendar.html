
{% extends "base.html" %}
{% load static i18n %}

{% block title %}
{% trans "Dein Kalender" %}
{% endblock %}

{% block head-optional %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
{% endblock %}

{% block content_area_classes %}scrollable{% endblock %}

{% block content %}

<div class="page-shell calendar-page">
  <section class="calendar-card accent-card">
    <div class="calendar-card__header">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">{% trans "Kalender" %}</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Behalte all deine Uni-Termine im Blick" %}</p>
      </div>
      <div class="calendar-card__actions" role="group" aria-label="{% trans 'Kalenderaktionen' %}">
        <div class="calendar-action">
          <span class="calendar-action-text">{% trans "Termin erstellen" %}</span>
          <button
            type="button"
            class="calendar-icon-btn"
            data-calendar-open
            aria-label="{% trans 'Termin erstellen' %}"
          >
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 5v14" /><path d="M19 12H5" /></svg>
          </button>
        </div>
        <div class="calendar-action">
          <span class="calendar-action-text">{% trans "Kalender importieren" %}</span>
          <button
            type="button"
            class="calendar-icon-btn"
            onclick="document.getElementById('icsUpload').click();"
            aria-label="{% trans 'Kalender importieren' %}"
          >
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 4v12" /><path d="M8 12l4 4 4-4" /><path d="M4 20h16" /></svg>
          </button>
        </div>
        <div class="calendar-action">
          <span class="calendar-action-text">{% trans "Kalender exportieren" %}</span>
          <button
            type="submit"
            form="exportForm"
            class="calendar-icon-btn"
            aria-label="{% trans 'Kalender exportieren' %}"
          >
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20V8" /><path d="M16 12l-4-4-4 4" /><path d="M4 4h16" /></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="calendar-grid-wrapper">
      <div id="calendar" class="calendar-grid"></div>
    </div>

    <!-- Versteckte Formulare für Import und Export -->
    <form id="icsForm" action="{% url 'import_ics' %}" method="post" enctype="multipart/form-data" class="hidden">
      {% csrf_token %}
      <input type="file" id="icsUpload" name="ics_file" accept=".ics" class="hidden" onchange="document.getElementById('icsForm').submit();">
    </form>
    <form id="exportForm" action="{% url 'export_ics' %}" method="get" class="hidden"></form>
  </section>
</div>

<!-- Popup für Terminerstellung und -bearbeitung -->
  <div
    id="eventPopup"
    class="calendar-modal hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="eventPopupTitle"
  >
    <!-- Overlay und Panel -->
    <div class="calendar-modal__overlay">
      <div class="calendar-modal__panel" role="document">
        <header class="calendar-modal__header">
          <!-- Farbakzent im Header -->
          <div class="calendar-modal__accent" aria-hidden="true"></div>
          <!-- Titel und Schließen-Button -->
          <h3 id="eventPopupTitle" class="calendar-modal__title">{% trans "Termin erstellen" %}</h3>
          <button
            type="button"
            id="closePopup"
            class="calendar-modal__close"
            aria-label="{% trans 'Popup schließen' %}"
          >&times;</button>
        </header>
        <form id="eventForm" class="calendar-form" novalidate>
          <!-- Optionaler Hinweis für schreibgeschützte Termine -->
          <p id="calendarReadOnlyNotice" class="calendar-form__notice hidden" role="status">
            {% trans "Dieser öffentliche Termin kann nur angezeigt werden." %}
          </p>
          <!-- Formularfelder -->
          <div class="calendar-form__field">
            <label for="eventTitle" class="form-label text-gray-700 dark:text-gray-100">{% trans "Titel" %}</label>
            <input
              type="text"
              id="eventTitle"
              class="calendar-input"
              required
            >
          </div>
          <div class="calendar-form__field calendar-form__field--inline">
            <span class="form-label text-gray-700 dark:text-gray-100">{% trans "Terminoptionen" %}</span>
            <button type="button" id="allDayBtn" class="calendar-all-day-btn">
              {% trans "Ganztägig" %}
            </button>
          </div>

          <div class="calendar-form__row">
            <div class="calendar-form__field">
              <label for="eventStartDate" class="form-label text-gray-700 dark:text-gray-100">{% trans "Beginn (Datum)" %}</label>
              <input
                type="date"
                id="eventStartDate"
                class="calendar-input"
                required
              >
            </div>
            <div class="calendar-form__field" id="eventStartTimeField">
              <label for="eventStartTime" class="form-label text-gray-700 dark:text-gray-100">{% trans "Beginn (Zeit)" %}</label>
              <div class="calendar-time-input">
                <input
                  type="text"
                  id="eventStartTime"
                  class="calendar-input calendar-input--time"
                  autocomplete="off"
                  required
                >
                <button
                  type="button"
                  id="startTimePickerBtn"
                  class="calendar-time-input__trigger"
                  aria-label="{% trans 'Zeit auswählen' %}"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
                <div id="startTimeDropdown" class="calendar-time-input__dropdown hidden"></div>
              </div>
            </div>
          </div>

          <div class="calendar-form__row">
            <div class="calendar-form__field">
              <label for="eventEndDate" class="form-label text-gray-700 dark:text-gray-100">{% trans "Ende (Datum)" %}</label>
              <input
                type="date"
                id="eventEndDate"
                class="calendar-input"
              >
            </div>
            <div class="calendar-form__field" id="eventEndTimeField">
              <label for="eventEndTime" class="form-label text-gray-700 dark:text-gray-100">{% trans "Ende (Zeit)" %}</label>
              <div class="calendar-time-input">
                <input
                  type="text"
                  id="eventEndTime"
                  class="calendar-input calendar-input--time"
                  autocomplete="off"
                >
                <button
                  type="button"
                  id="endTimePickerBtn"
                  class="calendar-time-input__trigger"
                  aria-label="{% trans 'Zeit auswählen' %}"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
                <div id="endTimeDropdown" class="calendar-time-input__dropdown hidden"></div>
              </div>
            </div>
          </div>

          <div class="calendar-form__field calendar-form__field--full">
            <label for="eventDescription" class="form-label text-gray-700 dark:text-gray-100">{% trans "Beschreibung" %}</label>
            <textarea
              id="eventDescription"
              class="calendar-textarea"
            ></textarea>
          </div>
          <button type="button" id="toggleRepeatOptions" class="calendar-section-toggle">
            <span>{% trans "Weitere Optionen" %}</span>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.293l3.71-4.063a.75.75 0 111.08 1.04l-4.25 4.66a.75.75 0 01-1.08 0l-4.25-4.66a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
            </svg>
          </button>
          <div id="repeatOptions" class="calendar-form__options hidden">
            <div class="calendar-form__field">
              <label for="eventRepeat" class="form-label text-gray-700 dark:text-gray-100">{% trans "Wiederholung" %}</label>
              <select id="eventRepeat" class="calendar-select">
                <option value="none">{% trans "Keine Wiederholung" %}</option>
                <option value="daily">{% trans "Täglich" %}</option>
                <option value="weekly">{% trans "Wöchentlich" %}</option>
                <option value="monthly">{% trans "Monatlich" %}</option>
                <option value="yearly">{% trans "Jährlich" %}</option>
              </select>
            </div>
            <div class="calendar-form__field">
              <label for="eventRepeatUntil" class="form-label text-gray-700 dark:text-gray-100">{% trans "Wiederholen bis" %}</label>
              <input
                type="date"
                id="eventRepeatUntil"
                class="calendar-input"
              >
            </div>
          </div>
          <div id="allInGroupContainer" class="calendar-form__checkbox hidden">
            <input type="checkbox" id="allInGroupCheckbox" class="calendar-checkbox">
            <label for="allInGroupCheckbox" id="allInGroupLabel">
              {% trans "Alle Termine dieser Serie bearbeiten/löschen" %}
            </label>
          </div>
          <div class="calendar-form__actions">
            <button type="submit" id="eventSubmitBtn" class="calendar-primary-btn">{% trans "Hinzufügen" %}</button>
            <button type="button" id="eventDeleteBtn" class="calendar-danger-btn hidden">{% trans "Löschen" %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast-Benachrichtigungen für Kalender-Aktionen -->
  <div
    id="calendarToast"
    class="calendar-toast hidden"
    role="status"
    aria-live="assertive"
    aria-atomic="true"
    aria-hidden="true"
  >
    <div class="calendar-toast__icon" aria-hidden="true"></div>
    <div class="calendar-toast__content">
      <p id="calendarToastTitle" class="calendar-toast__title">{% trans "Hinweis" %}</p>
      <p id="calendarToastMessage" class="calendar-toast__message"></p>
    </div>
    <button
      type="button"
      id="calendarToastClose"
      class="calendar-toast__close"
      aria-label="{% trans 'Hinweis schließen' %}"
    >&times;</button>
  </div>

  <!-- Bestätigungsdialog für sensible Aktionen (z. B. Löschen) -->
  <div
    id="calendarConfirm"
    class="calendar-confirm hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="calendarConfirmTitle"
    aria-hidden="true"
  >
    <div class="calendar-confirm__overlay">
      <div class="calendar-confirm__panel" role="document">
        <header class="calendar-confirm__header">
          <div class="calendar-confirm__accent" aria-hidden="true"></div>
          <h3 id="calendarConfirmTitle" class="calendar-confirm__title">{% trans "Bist du sicher?" %}</h3>
          <button
            type="button"
            id="calendarConfirmClose"
            class="calendar-confirm__close"
            aria-label="{% trans 'Bestätigungsdialog schließen' %}"
          >&times;</button>
        </header>
        <p id="calendarConfirmMessage" class="calendar-confirm__message"></p>
        <div class="calendar-confirm__actions">
          <button type="button" id="calendarConfirmCancel" class="calendar-secondary-btn">{% trans "Abbrechen" %}</button>
          <button type="button" id="calendarConfirmSubmit" class="calendar-danger-btn">{% trans "Bestätigen" %}</button>
        </div>
      </div>
    </div>
  </div>

<input type="hidden" id="csrfToken" value="{{ csrf_token }}">
<input type="hidden" id="currentUserId" value="{{ request.user.id }}">
<div
  id="calendarTranslations"
  class="hidden"
  data-toast-readonly-title="{% trans 'Nur Anzeige' %}"
  data-toast-readonly-message="{% trans 'Öffentliche Termine können nicht bearbeitet werden.' %}"
  data-toast-validation-title="{% trans 'Bitte Eingaben prüfen' %}"
  data-toast-create-success-title="{% trans 'Termin erstellt' %}"
  data-toast-update-success-title="{% trans 'Termin aktualisiert' %}"
  data-toast-error-title="{% trans 'Fehler' %}"
  data-toast-unknown-error-message="{% trans 'Unbekannter Fehler.' %}"
  data-toast-network-title="{% trans 'Netzwerkfehler' %}"
  data-toast-network-message="{% trans 'Event konnte nicht gespeichert werden. Bitte versuche es erneut.' %}"
  data-toast-delete-success-title="{% trans 'Termin gelöscht' %}"
  data-toast-delete-success-message="{% trans 'Event wurde gelöscht.' %}"
  data-toast-delete-error-title="{% trans 'Löschen fehlgeschlagen' %}"
  data-toast-delete-error-message="{% trans 'Unbekannter Fehler beim Löschen.' %}"
  data-toast-delete-network-message="{% trans 'Event konnte nicht gelöscht werden. Bitte versuche es erneut.' %}"
></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="/static/js/calendar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var userLang = '{{ request.LANGUAGE_CODE }}';
    if (!userLang) userLang = 'de';
    if (window.initCalendar) {
      window.initCalendar(userLang);
    }
  });
</script>
{% endblock %}
