
{% extends "base.html" %}
{% load i18n %}

{% block title %}
{% trans "4YouPage" %}
{% endblock %}

{% block page_class %}foryou-page{% endblock %}

{% block content %}
<div class="columns-row px-4 py-6 md:px-6">

    <!-- Linke Seite: Präferenzpanel -->

    <div id="4youfilter" class="side-column md:overflow-visible max-md:hidden max-md:fixed max-md:inset-y-0 max-md:right-0 max-md:z-40 max-md:w-[min(24rem,100%)] max-md:max-w-full max-md:p-4">
        <div class="accent-card scrollable filter-panel-card max-md:shadow-xl">
            <div class="mb-1 h-1 w-full rounded-full bg-gradient-to-r from-[var(--accent-primary)] via-[var(--accent-outline)] to-transparent opacity-80" aria-hidden="true"></div>
            <div class="flex items-start justify-between gap-4 pb-1">
                <div class="space-y-1">
                    <h2 class="accent-card-title text-xl md:text-2xl">{% trans "Deine Präferenzen" %}</h2>
                    <p class="text-xs leading-relaxed text-gray-500 dark:text-gray-400 md:text-sm">{% trans "Passe deine Präferenzen an" %}</p>
                </div>
                <button type="button" class="filter-close-btn" onclick="document.getElementById('4youfilter-button').click()" aria-label="{% trans 'Filter schließen' %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-4 w-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6l12 12M18 6 6 18" />
                    </svg>
                </button>
            </div>

            <form id="preferences-form" action="{% url 'preferences' %}" method="post" class="flex flex-col gap-4">
                {% csrf_token %}

                {% if preferences_form.non_field_errors %}
                <div class="space-y-1">
                    {% for error in preferences_form.non_field_errors %}
                    <p class="form-error">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <div id="preferences-feedback" hidden class="alert-banner" role="status" aria-live="polite">
                    <span class="alert-banner__dot"></span>
                    <span class="alert-banner__message"></span>
                </div>

                <div class="space-y-3">

                    <!-- Standorte -->
                    <div class="filter-section">
                        <button type="button" class="filter-toggle" data-filter-target="standorte" onclick="toggleFilter('standorte')" aria-controls="filter-standorte" aria-expanded="{% if preferences_form.standorte.value or preferences_form.standorte.errors %}true{% else %}false{% endif %}">
                            <span class="flex items-center gap-2">
                                <span class="inline-flex h-1.5 w-6 rounded-full bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-outline)] opacity-80" aria-hidden="true"></span>
                                <span>{{ preferences_form.standorte.label }}</span>
                            </span>
                            <svg id="chevron-standorte" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="{% if preferences_form.standorte.value or preferences_form.standorte.errors %}rotate-90{% endif %}">
                                <path fill-rule="evenodd" d="M7.22 14.78a.75.75 0 0 1 0-1.06L10.94 10 7.22 6.28a.75.75 0 1 1 1.06-1.06l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="filter-standorte" class="filter-options {% if not preferences_form.standorte.value and not preferences_form.standorte.errors %}hidden{% endif %}" aria-hidden="{% if preferences_form.standorte.value or preferences_form.standorte.errors %}false{% else %}true{% endif %}">
                            {% for checkbox in preferences_form.standorte %}
                            <label class="filter-checkbox" for="{{ checkbox.id_for_label }}">
                                {{ checkbox.tag }}
                                <span>{{ checkbox.choice_label|safe }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if preferences_form.standorte.errors %}
                        <div class="mt-2 space-y-1">
                            {% for error in preferences_form.standorte.errors %}
                            <p class="form-error">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Inhaltskategorien -->
                    <div class="filter-section">
                        <button type="button" class="filter-toggle" data-filter-target="kategorien" onclick="toggleFilter('kategorien')" aria-controls="filter-kategorien" aria-expanded="{% if preferences_form.inhaltskategorien.value or preferences_form.inhaltskategorien.errors %}true{% else %}false{% endif %}">
                            <span class="flex items-center gap-2">
                                <span class="inline-flex h-1.5 w-6 rounded-full bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-outline)] opacity-80" aria-hidden="true"></span>
                                <span>{{ preferences_form.inhaltskategorien.label }}</span>
                            </span>
                            <svg id="chevron-kategorien" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="{% if preferences_form.inhaltskategorien.value or preferences_form.inhaltskategorien.errors %}rotate-90{% endif %}">
                                <path fill-rule="evenodd" d="M7.22 14.78a.75.75 0 0 1 0-1.06L10.94 10 7.22 6.28a.75.75 0 1 1 1.06-1.06l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="filter-kategorien" class="filter-options {% if not preferences_form.inhaltskategorien.value and not preferences_form.inhaltskategorien.errors %}hidden{% endif %}" aria-hidden="{% if preferences_form.inhaltskategorien.value or preferences_form.inhaltskategorien.errors %}false{% else %}true{% endif %}">
                            {% for checkbox in preferences_form.inhaltskategorien %}
                            <label class="filter-checkbox" for="{{ checkbox.id_for_label }}">
                                {{ checkbox.tag }}
                                <span>{{ checkbox.choice_label|safe }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if preferences_form.inhaltskategorien.errors %}
                        <div class="mt-2 space-y-1">
                            {% for error in preferences_form.inhaltskategorien.errors %}
                            <p class="form-error">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Zielgruppen -->
                    <div class="filter-section">
                        <button type="button" class="filter-toggle" data-filter-target="zielgruppen" onclick="toggleFilter('zielgruppen')" aria-controls="filter-zielgruppen" aria-expanded="{% if preferences_form.zielgruppen.value or preferences_form.zielgruppen.errors %}true{% else %}false{% endif %}">
                            <span class="flex items-center gap-2">
                                <span class="inline-flex h-1.5 w-6 rounded-full bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-outline)] opacity-80" aria-hidden="true"></span>
                                <span>{{ preferences_form.zielgruppen.label }}</span>
                            </span>
                            <svg id="chevron-zielgruppen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="{% if preferences_form.zielgruppen.value or preferences_form.zielgruppen.errors %}rotate-90{% endif %}">
                                <path fill-rule="evenodd" d="M7.22 14.78a.75.75 0 0 1 0-1.06L10.94 10 7.22 6.28a.75.75 0 1 1 1.06-1.06l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="filter-zielgruppen" class="filter-options {% if not preferences_form.zielgruppen.value and not preferences_form.zielgruppen.errors %}hidden{% endif %}" aria-hidden="{% if preferences_form.zielgruppen.value or preferences_form.zielgruppen.errors %}false{% else %}true{% endif %}">
                            {% for checkbox in preferences_form.zielgruppen %}
                            <label class="filter-checkbox" for="{{ checkbox.id_for_label }}">
                                {{ checkbox.tag }}
                                <span>{{ checkbox.choice_label|safe }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if preferences_form.zielgruppen.errors %}
                        <div class="mt-2 space-y-1">
                            {% for error in preferences_form.zielgruppen.errors %}
                            <p class="form-error">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Quellen -->
                    <div class="filter-section">
                        <button type="button" class="filter-toggle" data-filter-target="quellen" onclick="toggleFilter('quellen')" aria-controls="filter-quellen" aria-expanded="{% if preferences_form.quellen.value or preferences_form.quellen.errors %}true{% else %}false{% endif %}">
                            <span class="flex items-center gap-2">
                                <span class="inline-flex h-1.5 w-6 rounded-full bg-gradient-to-r from-[var(--accent-primary)] to-[var(--accent-outline)] opacity-80" aria-hidden="true"></span>
                                <span>{{ preferences_form.quellen.label }}</span>
                            </span>
                            <svg id="chevron-quellen" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="{% if preferences_form.quellen.value or preferences_form.quellen.errors %}rotate-90{% endif %}">
                                <path fill-rule="evenodd" d="M7.22 14.78a.75.75 0 0 1 0-1.06L10.94 10 7.22 6.28a.75.75 0 1 1 1.06-1.06l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <div id="filter-quellen" class="filter-options {% if not preferences_form.quellen.value and not preferences_form.quellen.errors %}hidden{% endif %}" aria-hidden="{% if preferences_form.quellen.value or preferences_form.quellen.errors %}false{% else %}true{% endif %}">
                            {% for option in preferences_form.ordered_sources %}
                            <label class="filter-checkbox" for="{{ option.id }}">
                                {{ option.input_html|safe }}
                                <span>{{ option.label|safe }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if preferences_form.quellen.errors %}
                        <div class="mt-2 space-y-1">
                            {% for error in preferences_form.quellen.errors %}
                            <p class="form-error">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="filter-panel-actions">
                    <button type="submit" name="action" value="reset" id="preferences-reset-btn" class="accent-outline-btn w-full">{% trans "Zurücksetzen" %}</button>
                    <button type="submit" id="preferences-submit-btn" class="accent-solid-btn w-full">{% trans "Speichern" %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mitte: News -->

    <div id="news" class="middle-column scrollable">
        <div id="news-container" class="flex flex-col gap-4">
            {% include "news/partials/_news_list.html" with news_list=news_list has_more=has_more %}
        </div>
    </div>

    <!-- Rechte Seite: Terminkalender -->

    <div id="calendar" class="side-column md:overflow-visible">
        <div class="accent-card scrollable filter-panel-card">
            <div class="mb-1 h-1 w-full rounded-full bg-gradient-to-r from-[var(--accent-primary)] via-[var(--accent-outline)] to-transparent opacity-80" aria-hidden="true"></div>
            <div class="space-y-1">
                <h2 class="accent-card-title text-xl md:text-2xl">{% trans "Nächste Termine" %}</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Ein Blick in den Kalender" %}</p>
            </div>
            {% if upcoming_events %}
            <div class="flex-1">
                <ul class="flex flex-col gap-3">
                    {% for event in upcoming_events %}
                    <li>
                        <a href="{% url 'calendar_page' %}" class="accent-card-link flex items-center gap-3">
                            <span class="h-2 w-2 shrink-0 rounded-full bg-[var(--accent-outline)]" aria-hidden="true"></span>
                            <div class="flex flex-col">
                                <p class="font-semibold text-gray-800 dark:text-gray-100">{{ event.title }}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-300">{{ event.start|date:"d.m.Y H:i" }} &ndash; {{ event.end|date:"H:i" }}</p>
                            </div>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <a href="{% url 'calendar_page' %}" class="accent-link mt-3">{% trans "Alle Termine anzeigen" %}</a>
            {% else %}
            <div class="flex flex-1 flex-col items-center justify-center rounded-md bg-gray-100 px-4 py-6 text-center text-sm text-gray-500 dark:bg-gray-700 dark:text-gray-300">
                {% trans "Keine anstehenden Termine." %}
            </div>
            <a href="{% url 'calendar_page' %}" class="accent-link mt-3 self-center">{% trans "Zum Kalender" %}</a>
            {% endif %}
        </div>
    </div>
</div>

<button type="button" class="accent-fab" data-dropdown-toggle="4youfilter" id="4youfilter-button" aria-controls="4youfilter" aria-expanded="false">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="h-6 w-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h18M6 12h12m-9 7h6" />
    </svg>
</button>
<div id="foryou-filter-overlay" class="fixed inset-0 z-30 hidden bg-gray-900/60 md:hidden"></div>

<script src="{% static 'js/newsFeedCore.js' %}"></script>
<script src="{% static 'js/foryoupage.js' %}"></script>
{% endblock %}
